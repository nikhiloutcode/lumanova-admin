/*!
 DMXzone S3 Upload
 Version: 1.1.2
 (c) 2022 Wappler.io
 @build 2022-03-30 16:11:02
 */
dmx.Actions({"s3.upload":function(t){var e=this.parse(t.input),i=this.parse(t.url),s=document.getElementById(e).files[0];return new Promise((function(t,e){var n=new XMLHttpRequest;n.onerror=e,n.onabort=e,n.ontimeout=e,n.onload=t,n.open("PUT",i),n.setRequestHeader("Content-Type",s.type),n.send(s)}))}}),dmx.Component("s3-upload",{initialData:{data:null,file:null,state:{idle:!0,ready:!1,uploading:!1,done:!1},uploadProgress:{position:0,total:0,percent:0},lastError:{status:0,message:"",response:null}},attributes:{url:{type:String,default:null},prop:{type:String,default:"url"},accept:{type:String,default:null},autoupload:{type:Boolean,default:!1}},methods:{abort:function(){this.abort()},reset:function(){this.reset()},select:function(){this.input.click()},upload:function(){this.upload()}},events:{start:Event,done:Event,error:Event,abort:Event,success:Event,upload:ProgressEvent},render:function(t){this.$node.addEventListener("dragover",this.onDragover.bind(this)),this.$node.addEventListener("drop",this.onDrop.bind(this)),this.$node.addEventListener("click",this.onClick.bind(this)),this.input=document.createElement("input"),this.input.type="file",this.input.accept=this.props.accept||"*/*",this.input.addEventListener("change",this.onChange.bind(this)),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("abort",this.onAbort.bind(this)),this.xhr.addEventListener("error",this.onError.bind(this)),this.xhr.addEventListener("timeout",this.onTimeout.bind(this)),this.xhr.addEventListener("load",this.onLoad.bind(this)),this.xhr.upload.addEventListener("progress",this.onProgress.bind(this)),this.$parse()},update:function(t){this.props.accept!=t.accept&&(this.input.accept=this.props.accept||"*/*")},onDragover:function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect=1==t.dataTransfer.items.length?"copy":"none"},onDrop:function(t){t.stopPropagation(),t.preventDefault(),1==t.dataTransfer.files.length&&this.updateFile(t.dataTransfer.files[0])},onClick:function(t){this.input.click()},onChange:function(t){this.updateFile(t.target.files[0]),this.input.value="",this.input.type="",this.input.type="file"},onAbort:function(t){this.set({data:null,state:{idle:!1,ready:!0,uploading:!1,done:!1},uploadProgress:{position:0,total:0,percent:0}}),this.dispatchEvent("abort"),this.dispatchEvent("done")},onError:function(t){t instanceof ProgressEvent&&(t="Network error, perhaps no CORS set"),this.set({data:null,state:{idle:!1,ready:!0,uploading:!1,done:!1},uploadProgress:{position:0,total:0,percent:0},lastError:{status:0,message:t,response:null}}),console.error(t),this.dispatchEvent("error"),this.dispatchEvent("done")},onTimeout:function(t){this.onError("Execution timeout")},onLoad:function(t){this.xhr.status>=400?this.onError(this.xhr.responseText):(this.set({state:{idle:!1,ready:!1,uploading:!1,done:!0},uploadProgress:{position:this.file.size,total:this.file.size,percent:100}}),this.dispatchEvent("success"),this.dispatchEvent("done"))},onProgress:function(t){this.set({state:{idle:!1,ready:!1,uploading:!0,done:!1},uploadProgress:{position:t.loaded,total:this.file.size,percent:Math.ceil(t.loaded/t.total*100)}}),this.dispatchEvent("upload",{lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total})},_validate:function(t){return!this.props.accept||this.props.accept.split(/\s*,\s*/g).some((function(e){if("."==e.charAt(0)){if(t.name.match(new RegExp("\\"+e+"$","i")))return!0}else if(/(audio|video|image)\/\*/i.test(e)){if(t.type.match(new RegExp("^"+e.replace(/\*/g,".*")+"$","i")))return!0}else if(t.type.toLowerCase()==e.toLowerCase())return!0;return!1}))},updateFile:function(t){if(this._validate(t)){var e={name:t.name,size:t.size,type:t.type,date:(t.lastModified?new Date(t.lastModified):t.lastModifiedDate).toISOString(),dataUrl:null};-1===t.type.indexOf("image/")||t.reader||(t.reader=new FileReader,t.reader.onload=function(t){e.dataUrl=t.target.result,dmx.requestUpdate()}.bind(this),t.reader.readAsDataURL(t)),this.file=t,this.set({file:e,state:{idle:!1,ready:!0,uploading:!1,done:!1}}),this.props.autoupload&&this.upload()}},abort:function(){this.xhr.abort()},reset:function(){this.abort(),this.file=null,this.set({data:null,file:null,state:{idle:!0,ready:!1,uploading:!1,done:!1},uploadProgress:{position:0,total:0,percent:0},lastError:{status:0,message:"",response:null}})},upload:function(){if(this.props.url){this.set({state:{idle:!1,ready:!1,uploading:!0,done:!1}}),this.dispatchEvent("start");var t=new XMLHttpRequest;t.onabort=this.onAbort.bind(this),t.onerror=this.onError.bind(this),t.onload=this.upload2.bind(this,t),t.open("GET",this.props.url+"?name="+encodeURIComponent(this.file.name)),t.send()}else this.onError("No url attribute is set")},upload2:function(t){try{var e=JSON.parse(t.responseText),i=e[this.props.prop];if(this.set("data",e),this.xhr.open("PUT",i),this.xhr.setRequestHeader("Content-Type",this.file.type),-1!=i.indexOf("x-amz-acl=")){var s=i.substr(i.indexOf("x-amz-acl=")+10);-1!=s.indexOf("&")&&(s=s.substr(0,s.indexOf("&"))),this.xhr.setRequestHeader("x-amz-acl",s)}this.xhr.send(this.file)}catch(t){this.onError(t)}}}),dmx.Component("s3-upload-multi",{initialData:{data:null,files:[],state:{idle:!0,ready:!1,uploading:!1},lastError:""},attributes:{url:{type:String,default:null},prop:{type:String,default:"url"},accept:{type:String,default:null},autoupload:{type:Boolean,default:!1},thumbs:{type:String,default:"true"},"thumb-width":{type:Number,default:100},"thumb-height":{type:Number,default:100}},methods:{abort:function(){this.abort()},reset:function(){this.reset()},select:function(){this.input.click()},remove:function(t){this.remove(t)},upload:function(){this.startUpload()}},events:{start:Event,done:Event,error:Event,abort:Event,success:Event},render:function(t){this.$node.addEventListener("dragover",this.onDragover.bind(this)),this.$node.addEventListener("drop",this.onDrop.bind(this)),this.$node.addEventListener("click",this.onClick.bind(this)),this.input=document.createElement("input"),this.input.type="file",this.input.multiple=!0,this.input.accept=this.props.accept||"*/*",this.input.addEventListener("change",this.onChange.bind(this)),this.maxRetries=5,this.uploads=[],this.ii=0,this.$parse()},update:function(t){this.props.accept!=t.accept&&(this.input.accept=this.props.accept||"*/*"),this.uploads.length?this.isUploading()?this.set("state",{idle:!1,ready:!1,uploading:!0}):this.set("state",{idle:!1,ready:!0,uploading:!1}):this.set("state",{idle:!0,ready:!1,uploading:!1})},isUploading:function(){return!!this.uploads.find((function(t){return t.info.uploading}),this)},nextRetry:function(t){return 3e3*(this.maxRetries-t+1)},_validate:function(t){return!this.props.accept||this.props.accept.split(/\s*,\s*/g).some((function(e){if("."==e.charAt(0)){if(t.name.match(new RegExp("\\"+e+"$","i")))return!0}else if(/(audio|video|image)\/\*/i.test(e)){if(t.type.match(new RegExp("^"+e.replace(/\*/g,".*")+"$","i")))return!0}else if(t.type.toLowerCase()==e.toLowerCase())return!0;return!1}))},onDragover:function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"},onDrop:function(t){if(t.stopPropagation(),t.preventDefault(),t.dataTransfer){var e=t.dataTransfer.files;if(e.length){var i=t.dataTransfer.items;i&&i.length&&i[0].webkitGetAsEntry?this.updateFilesFromItems(i):this.updateFiles(e)}}},onClick:function(t){this.input.click()},onChange:function(t){this.updateFiles(t.target.files),this.input.value="",this.input.type="",this.input.type="file"},onAbort:function(t,e){t.info.uploading=!1,t.info.uploaded=0,t.info.percent=0,dmx.requestUpdate(),this.isUploading()||(this.dispatchEvent("abort"),this.dispatchEvent("done"))},onError:function(t,e){t.url&&t.retries?setTimeout(this.upload3.bind(this,t),this.nextRetry(t.retries--)):(e=e instanceof ProgressEvent?"Network error, perhaps no CORS set":e.message||e,this.set("lastError",e),t.info.uploading=!1,t.info.uploaded=0,t.info.percent=0,t.info.error=e,dmx.requestUpdate(),this.isUploading()||(this.dispatchEvent("error"),this.dispatchEvent("done")))},onTimeout:function(t,e){this.onError(t,"Execution timeout")},onLoad:function(t,e){t.xhr.status>=500||429==t.xhr.status?t.retries?setTimeout(this.upload3.bind(this,t),this.nextRetry(t.retries--)):this.onError(t,t.xhr.responseText||t.xhr.statusText):t.xhr.status>=400?this.onError(t,t.xhr.responseText||t.xhr.statusText):(this.remove(t.file.id),dmx.requestUpdate(),this.isUploading()||(this.uploads.length?this.dispatchEvent("error"):this.dispatchEvent("success"),this.dispatchEvent("done")))},onProgress:function(t,e){t.info.uploaded=e.loaded,t.info.percent=e.lengthComputable?Math.ceil(e.loaded/e.total*100):0,dmx.requestUpdate()},resize:function(t,e){var i=document.createElement("img"),s=parseInt(this.props["thumb-width"])||100,n=parseInt(this.props["thumb-height"])||100;i.onload=function(){var t=document.createElement("canvas"),r=t.getContext("2d"),o=i.width,a=i.height;s=Math.min(s,o),n=Math.min(n,a);var d=s/n;(o>s||a>n)&&(o/a>d?o=a*d:a=o/d),t.width=s,t.height=n;var h=(i.width-o)/2,l=(i.height-a)/2;r.drawImage(i,h,l,o,a,0,0,s,n),e(t.toDataURL())},i.src=t},updateFile:function(t){if(this._validate(t)){t.id=++this.ii;var e={id:t.id,name:t.name,size:t.size,type:t.type,date:(t.lastModified?new Date(t.lastModified):t.lastModifiedDate).toISOString(),data:null,uploading:!1,uploaded:0,percent:0,ready:!1,error:null,dataUrl:null};-1===t.type.indexOf("image/")||t.reader?e.ready=!0:(t.reader=new FileReader,t.reader.onload=function(t){e.dataUrl=t.target.result,this.props.thumbs?this.resize(e.dataUrl,(function(t){e.dataUrl=t,e.ready=!0,dmx.requestUpdate()})):e.ready=!0,dmx.requestUpdate()}.bind(this),t.reader.readAsDataURL(t));var i={retries:this.maxRetries,info:e,file:t,xhr:null};this.uploads.push(i),this.set({files:this.data.files.concat([e]),state:{idle:!1,ready:!0,uploading:!1,done:!1}}),this.props.autoupload&&(this.isUploading()||this.dispatchEvent("start"),this.upload(i))}},updateFiles:function(t){dmx.array(t).forEach((function(t){this.updateFile(t)}),this)},updateFilesFromItems:function(t){dmx.array(t).forEach((function(t){var e;t.webkitGetAsEntry&&(e=t.webkitGetAsEntry())?e.isFile?this.updateFile(t.getAsFile()):e.isDirectory&&this.updateFilesFromDirectory(e):t.getAsFile&&(t.kind&&"file"!=t.kind||this.updateFile(t.getAsFile()))}),this)},updateFilesFromDirectory:function(t,e){var i=t.createReader(),s=function(){i.readEntries(function(t){t.length&&t.forEach((function(t){t.isFile?t.file(function(t){t.fullPath=e+"/"+t.name,this.updateFile(t)}.bind(this)):t.isDirectory&&this.updateFilesFromDirectory(t,e+"/"+t.name)}),this),s()}.bind(this),function(t){console.warn(t)}.bind(this))}.bind(this);s()},abort:function(){this.uploads.forEach((function(t){t.xhr&&t.xhr.abort()}))},reset:function(){this.abort(),this.uploads=[],this.set({data:null,files:[],state:{idle:!0,ready:!1,uploading:!1},lastError:""})},remove:function(t){var e=this.uploads.findIndex((function(e){return e.file.id==t}));-1!=e&&(this.uploads[e].xhr&&this.uploads[e].xhr.abort(),this.uploads.splice(e,1),this.data.files.splice(e,1),dmx.requestUpdate())},startUpload:function(){this.dispatchEvent("start"),this.uploads.forEach((function(t){this.upload(t)}),this)},upload:function(t){t.info&&t.info.uploading||(this.props.url?(this.set({state:{idle:!1,ready:!1,uploading:!0,done:!1}}),t.info.uploading=!0,dmx.requestUpdate(),t.xhr=new XMLHttpRequest,t.xhr.onabort=this.onAbort.bind(this,t),t.xhr.onerror=this.onError.bind(this,t),t.xhr.ontimeout=this.onTimeout.bind(this,t),t.xhr.onload=this.upload2.bind(this,t),t.xhr.open("GET",this.props.url+"?name="+encodeURIComponent(t.file.name)),t.xhr.send()):this.onError("No url attribute is set"))},upload2:function(t){try{t.info.data=JSON.parse(t.xhr.responseText),t.url=t.info.data[this.props.prop],t.xhr.onload=this.onLoad.bind(this,t),t.xhr.upload.addEventListener("progress",this.onProgress.bind(this,t)),this.upload3(t)}catch(e){this.onError(t,e)}},upload3:function(t){try{if(t.xhr.open("PUT",t.url),t.xhr.setRequestHeader("Content-Type",t.file.type),-1!=t.url.indexOf("x-amz-acl=")){var e=t.url.substr(t.url.indexOf("x-amz-acl=")+10);-1!=e.indexOf("&")&&(e=e.substr(0,e.indexOf("&"))),t.xhr.setRequestHeader("x-amz-acl",e)}t.xhr.send(t.file)}catch(e){t.retries?(console.log("Retry upload",t),setTimeout(this.upload3.bind(this,t),this.nextRetry(t.retries--))):(console.log("Error in upload",t,e),this.onError(t,e))}}});
//# sourceMappingURL=../maps/dmxS3Upload.js.map
