{
  "meta": {
    "$_PARAM": [
      {
        "type": "text",
        "name": "userId"
      },
      {
        "type": "text",
        "name": "serial"
      },
      {
        "type": "text",
        "name": "fullAccess"
      }
    ]
  },
  "exec": {
    "steps": [
      {
        "name": "client",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "select",
            "columns": [],
            "params": [
              {
                "operator": "equal",
                "type": "expression",
                "name": ":P1",
                "value": "{{$_PARAM.userId}}",
                "test": "128"
              }
            ],
            "table": {
              "name": "client"
            },
            "primary": "id",
            "joins": [],
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "client.userId",
                  "field": "client.userId",
                  "type": "double",
                  "operator": "equal",
                  "value": "{{$_PARAM.userId}}",
                  "data": {
                    "table": "client",
                    "column": "userId",
                    "type": "number",
                    "columnObj": {
                      "type": "reference",
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "references": "id",
                      "inTable": "user",
                      "referenceType": "integer",
                      "onUpdate": "CASCADE",
                      "onDelete": "CASCADE",
                      "name": "userId"
                    }
                  },
                  "operation": "="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "query": "select * from \"client\" where \"client\".\"userId\" = ?"
          }
        },
        "meta": [
          {
            "type": "number",
            "name": "id"
          },
          {
            "type": "text",
            "name": "height"
          },
          {
            "type": "text",
            "name": "weight"
          },
          {
            "type": "text",
            "name": "sickDays"
          },
          {
            "type": "number",
            "name": "eyeColor"
          },
          {
            "type": "number",
            "name": "hairColor"
          },
          {
            "type": "number",
            "name": "skinColor"
          },
          {
            "type": "number",
            "name": "userId"
          },
          {
            "type": "text",
            "name": "birth"
          },
          {
            "type": "number",
            "name": "freckles"
          },
          {
            "type": "number",
            "name": "sunTooLong"
          },
          {
            "type": "number",
            "name": "degreeTurnBrown"
          },
          {
            "type": "number",
            "name": "brownSeveralHours"
          },
          {
            "type": "number",
            "name": "facialReactionSun"
          },
          {
            "type": "number",
            "name": "tanning"
          },
          {
            "type": "number",
            "name": "exposedArea"
          },
          {
            "type": "text",
            "name": "gender"
          },
          {
            "type": "datetime",
            "name": "consentTreatment"
          },
          {
            "type": "number",
            "name": "treatments"
          },
          {
            "type": "text",
            "name": "customerId"
          },
          {
            "type": "number",
            "name": "scoreGeneticDisposition"
          },
          {
            "type": "number",
            "name": "scoreReactionSun"
          },
          {
            "type": "number",
            "name": "scoreTanningHabits"
          },
          {
            "type": "number",
            "name": "skintype"
          },
          {
            "type": "boolean",
            "name": "hasFreeTrial"
          }
        ],
        "type": "dbconnector_single",
        "outputType": "object",
        "output": false
      },
      {
        "name": "scoreGeneticDisposition",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{client.eyeColor+client.hairColor+client.skinColor+client.freckles}}"
        },
        "meta": [
          {
            "name": "id",
            "type": "number"
          },
          {
            "name": "height",
            "type": "text"
          },
          {
            "name": "weight",
            "type": "text"
          },
          {
            "name": "sickDays",
            "type": "text"
          },
          {
            "name": "eyeColor",
            "type": "number"
          },
          {
            "name": "hairColor",
            "type": "number"
          },
          {
            "name": "skinColor",
            "type": "number"
          },
          {
            "name": "userId",
            "type": "number"
          },
          {
            "name": "birth",
            "type": "text"
          },
          {
            "name": "freckles",
            "type": "number"
          },
          {
            "name": "sunTooLong",
            "type": "number"
          },
          {
            "name": "degreeTurnBrown",
            "type": "number"
          },
          {
            "name": "brownSeveralHours",
            "type": "number"
          },
          {
            "name": "facialReactionSun",
            "type": "number"
          },
          {
            "name": "tanning",
            "type": "number"
          },
          {
            "name": "exposedArea",
            "type": "number"
          },
          {
            "name": "gender",
            "type": "text"
          },
          {
            "name": "consentTreatment",
            "type": "datetime"
          },
          {
            "name": "treatments",
            "type": "number"
          },
          {
            "name": "customerId",
            "type": "text"
          },
          {
            "name": "scoreGeneticDisposition",
            "type": "number"
          },
          {
            "name": "scoreReactionSun",
            "type": "number"
          },
          {
            "name": "scoreTanningHabits",
            "type": "number"
          },
          {
            "name": "skintype",
            "type": "number"
          },
          {
            "name": "hasFreeTrial",
            "type": "boolean"
          }
        ],
        "outputType": "text"
      },
      {
        "name": "scoreReactionSun",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{client.sunTooLong+client.degreeTurnBrown+client.brownSeveralHours+client.facialReactionSun}}"
        },
        "meta": [
          {
            "name": "id",
            "type": "number"
          },
          {
            "name": "height",
            "type": "text"
          },
          {
            "name": "weight",
            "type": "text"
          },
          {
            "name": "sickDays",
            "type": "text"
          },
          {
            "name": "eyeColor",
            "type": "number"
          },
          {
            "name": "hairColor",
            "type": "number"
          },
          {
            "name": "skinColor",
            "type": "number"
          },
          {
            "name": "userId",
            "type": "number"
          },
          {
            "name": "birth",
            "type": "text"
          },
          {
            "name": "freckles",
            "type": "number"
          },
          {
            "name": "sunTooLong",
            "type": "number"
          },
          {
            "name": "degreeTurnBrown",
            "type": "number"
          },
          {
            "name": "brownSeveralHours",
            "type": "number"
          },
          {
            "name": "facialReactionSun",
            "type": "number"
          },
          {
            "name": "tanning",
            "type": "number"
          },
          {
            "name": "exposedArea",
            "type": "number"
          },
          {
            "name": "gender",
            "type": "text"
          },
          {
            "name": "consentTreatment",
            "type": "datetime"
          },
          {
            "name": "treatments",
            "type": "number"
          },
          {
            "name": "customerId",
            "type": "text"
          },
          {
            "name": "scoreGeneticDisposition",
            "type": "number"
          },
          {
            "name": "scoreReactionSun",
            "type": "number"
          },
          {
            "name": "scoreTanningHabits",
            "type": "number"
          },
          {
            "name": "skintype",
            "type": "number"
          },
          {
            "name": "hasFreeTrial",
            "type": "boolean"
          }
        ],
        "outputType": "text"
      },
      {
        "name": "scoreTanningHabits",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{client.tanning+client.exposedArea}}"
        },
        "meta": [
          {
            "name": "id",
            "type": "number"
          },
          {
            "name": "height",
            "type": "text"
          },
          {
            "name": "weight",
            "type": "text"
          },
          {
            "name": "sickDays",
            "type": "text"
          },
          {
            "name": "eyeColor",
            "type": "number"
          },
          {
            "name": "hairColor",
            "type": "number"
          },
          {
            "name": "skinColor",
            "type": "number"
          },
          {
            "name": "userId",
            "type": "number"
          },
          {
            "name": "birth",
            "type": "text"
          },
          {
            "name": "freckles",
            "type": "number"
          },
          {
            "name": "sunTooLong",
            "type": "number"
          },
          {
            "name": "degreeTurnBrown",
            "type": "number"
          },
          {
            "name": "brownSeveralHours",
            "type": "number"
          },
          {
            "name": "facialReactionSun",
            "type": "number"
          },
          {
            "name": "tanning",
            "type": "number"
          },
          {
            "name": "exposedArea",
            "type": "number"
          },
          {
            "name": "gender",
            "type": "text"
          },
          {
            "name": "consentTreatment",
            "type": "datetime"
          },
          {
            "name": "treatments",
            "type": "number"
          },
          {
            "name": "customerId",
            "type": "text"
          },
          {
            "name": "scoreGeneticDisposition",
            "type": "number"
          },
          {
            "name": "scoreReactionSun",
            "type": "number"
          },
          {
            "name": "scoreTanningHabits",
            "type": "number"
          },
          {
            "name": "skintype",
            "type": "number"
          },
          {
            "name": "hasFreeTrial",
            "type": "boolean"
          }
        ],
        "outputType": "text"
      },
      {
        "name": "scoreSkinType",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{scoreGeneticDisposition+scoreReactionSun+scoreTanningHabits}}"
        },
        "meta": [],
        "outputType": "text"
      },
      {
        "name": "skinTypeDB",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "sql": {
            "type": "SELECT",
            "distinct": false,
            "columns": [
              {
                "table": "fitzpatrickSkinType",
                "column": "skinType"
              },
              {
                "table": "fitzpatrickSkinType",
                "column": "id"
              }
            ],
            "table": {
              "name": "fitzpatrickSkinType"
            },
            "joins": [],
            "orders": [],
            "params": [
              {
                "operator": "less_or_equal",
                "type": "expression",
                "name": ":P1",
                "value": "{{scoreSkinType}}",
                "test": ""
              },
              {
                "operator": "greater_or_equal",
                "type": "expression",
                "name": ":P2",
                "value": "{{scoreSkinType}}",
                "test": ""
              }
            ],
            "primary": "id",
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "fitzpatrickSkinType.lowScore",
                  "field": "fitzpatrickSkinType.lowScore",
                  "type": "double",
                  "operator": "less_or_equal",
                  "value": "{{scoreSkinType}}",
                  "data": {
                    "table": "fitzpatrickSkinType",
                    "column": "lowScore",
                    "type": "number",
                    "columnObj": {
                      "type": "integer",
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "lowScore"
                    }
                  },
                  "operation": "<="
                },
                {
                  "id": "fitzpatrickSkinType.highScore",
                  "field": "fitzpatrickSkinType.highScore",
                  "type": "double",
                  "operator": "greater_or_equal",
                  "value": "{{scoreSkinType}}",
                  "data": {
                    "table": "fitzpatrickSkinType",
                    "column": "highScore",
                    "type": "number",
                    "columnObj": {
                      "type": "integer",
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "highScore"
                    }
                  },
                  "operation": ">="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "query": "select \"skinType\", \"id\" from \"fitzpatrickSkinType\" where \"fitzpatrickSkinType\".\"lowScore\" <= ? and \"fitzpatrickSkinType\".\"highScore\" >= ?"
          },
          "connection": "EnyrgyDB"
        },
        "meta": [
          {
            "type": "number",
            "name": "skinType"
          },
          {
            "type": "number",
            "name": "id"
          }
        ],
        "type": "dbconnector_single",
        "outputType": "object"
      },
      {
        "name": "skinType",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "skinType",
          "value": "{{skinTypeDB.skinType}}"
        },
        "meta": [],
        "output": true,
        "outputType": "text"
      },
      {
        "name": "updateTotals",
        "module": "dbupdater",
        "action": "update",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "update",
            "values": [
              {
                "table": "client",
                "column": "scoreGeneticDisposition",
                "type": "number",
                "value": "{{scoreGeneticDisposition}}"
              },
              {
                "table": "client",
                "column": "scoreReactionSun",
                "type": "number",
                "value": "{{scoreReactionSun}}"
              },
              {
                "table": "client",
                "column": "scoreTanningHabits",
                "type": "number",
                "value": "{{scoreTanningHabits}}"
              },
              {
                "table": "client",
                "column": "skintype",
                "type": "number",
                "value": "{{skinType}}"
              }
            ],
            "table": "client",
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "userId",
                  "field": "userId",
                  "type": "double",
                  "operator": "equal",
                  "value": "{{$_PARAM.userId}}",
                  "data": {
                    "column": "userId"
                  },
                  "operation": "="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "returning": "id",
            "query": "update \"client\" set \"scoreGeneticDisposition\" = ?, \"scoreReactionSun\" = ?, \"scoreTanningHabits\" = ?, \"skintype\" = ? where \"userId\" = ? returning \"id\"",
            "params": [
              {
                "name": ":P1",
                "type": "expression",
                "value": "{{scoreGeneticDisposition}}",
                "test": ""
              },
              {
                "name": ":P2",
                "type": "expression",
                "value": "{{scoreReactionSun}}",
                "test": ""
              },
              {
                "name": ":P3",
                "type": "expression",
                "value": "{{scoreTanningHabits}}",
                "test": ""
              },
              {
                "name": ":P4",
                "type": "expression",
                "value": "{{skinType}}",
                "test": ""
              },
              {
                "operator": "equal",
                "type": "expression",
                "name": ":P5",
                "value": "{{$_PARAM.userId}}",
                "test": ""
              }
            ]
          }
        },
        "meta": [
          {
            "name": "affected",
            "type": "number"
          }
        ]
      },
      {
        "name": "hasPlan",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "SELECT",
            "distinct": false,
            "columns": [
              {
                "table": "detailsPayment",
                "column": "*",
                "field": "*"
              }
            ],
            "table": {
              "name": "detailsPayment"
            },
            "joins": [],
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "detailsPayment.clientId",
                  "field": "detailsPayment.clientId",
                  "type": "double",
                  "operator": "equal",
                  "value": "{{client.id}}",
                  "data": {
                    "table": "detailsPayment",
                    "column": "clientId",
                    "type": "number",
                    "columnObj": {
                      "type": "reference",
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "references": "id",
                      "inTable": "client",
                      "referenceType": "integer",
                      "onUpdate": "CASCADE",
                      "onDelete": "CASCADE",
                      "name": "clientId"
                    }
                  },
                  "operation": "=",
                  "table": "detailsPayment"
                },
                {
                  "id": "detailsPayment.status",
                  "field": "detailsPayment.status",
                  "type": "string",
                  "operator": "equal",
                  "value": "active",
                  "data": {
                    "table": "detailsPayment",
                    "column": "status",
                    "type": "text",
                    "columnObj": {
                      "type": "string",
                      "maxLength": 255,
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "status"
                    }
                  },
                  "operation": "=",
                  "table": "detailsPayment"
                }
              ],
              "conditional": null,
              "valid": true
            },
            "orders": [],
            "params": [
              {
                "operator": "equal",
                "type": "expression",
                "name": ":P1",
                "value": "{{client.id}}",
                "test": "101"
              }
            ],
            "primary": "id",
            "query": "select * from \"detailsPayment\" where \"detailsPayment\".\"clientId\" = ? and \"detailsPayment\".\"status\" = ?",
            "dir": "",
            "sort": ""
          }
        },
        "output": false,
        "meta": [
          {
            "type": "number",
            "name": "id"
          },
          {
            "type": "text",
            "name": "status"
          },
          {
            "type": "number",
            "name": "clientId"
          },
          {
            "type": "text",
            "name": "subscriptionStripeId"
          },
          {
            "type": "datetime",
            "name": "createdAt"
          },
          {
            "type": "datetime",
            "name": "updatedAt"
          },
          {
            "type": "number",
            "name": "planId"
          },
          {
            "type": "datetime",
            "name": "canceledAt"
          },
          {
            "type": "datetime",
            "name": "freeTrialEndAt"
          }
        ],
        "outputType": "object",
        "type": "dbconnector_single"
      },
      {
        "name": "hasPlan",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "hasPlan",
          "value": "{{!!hasPlan}}"
        },
        "meta": [],
        "outputType": "boolean",
        "output": true
      },
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{hasPlan||$_PARAM.fullAccess}}",
          "then": {
            "steps": {
              "name": "facility",
              "module": "dbconnector",
              "action": "single",
              "options": {
                "connection": "EnyrgyDB",
                "sql": {
                  "type": "select",
                  "columns": [
                    {
                      "table": "facility",
                      "column": "*"
                    }
                  ],
                  "params": [
                    {
                      "operator": "equal",
                      "type": "expression",
                      "name": ":P1",
                      "value": "{{$_PARAM.serial}}",
                      "test": ""
                    }
                  ],
                  "table": {
                    "name": "facility"
                  },
                  "primary": "id",
                  "joins": [
                    {
                      "table": "device",
                      "column": "*",
                      "type": "INNER",
                      "clauses": {
                        "condition": "AND",
                        "rules": [
                          {
                            "table": "device",
                            "column": "facilityId",
                            "operator": "equal",
                            "operation": "=",
                            "value": {
                              "table": "facility",
                              "column": "id"
                            }
                          }
                        ]
                      },
                      "primary": "id"
                    }
                  ],
                  "wheres": {
                    "condition": "AND",
                    "rules": [
                      {
                        "id": "device.serial",
                        "field": "device.serial",
                        "type": "string",
                        "operator": "equal",
                        "value": "{{$_PARAM.serial}}",
                        "data": {
                          "table": "device",
                          "column": "serial",
                          "type": "text",
                          "columnObj": {
                            "type": "string",
                            "maxLength": 255,
                            "primary": false,
                            "unique": false,
                            "nullable": true,
                            "name": "serial"
                          }
                        },
                        "operation": "="
                      }
                    ],
                    "conditional": null,
                    "valid": true
                  },
                  "query": "select \"facility\".* from \"facility\" inner join \"device\" on \"device\".\"facilityId\" = \"facility\".\"id\" where \"device\".\"serial\" = ?"
                }
              },
              "meta": [
                {
                  "type": "number",
                  "name": "id"
                },
                {
                  "type": "text",
                  "name": "logo"
                },
                {
                  "type": "text",
                  "name": "phone"
                },
                {
                  "type": "boolean",
                  "name": "disabled"
                },
                {
                  "type": "datetime",
                  "name": "createdAt"
                },
                {
                  "type": "datetime",
                  "name": "updatedAt"
                },
                {
                  "type": "text",
                  "name": "name"
                },
                {
                  "type": "text",
                  "name": "email"
                },
                {
                  "type": "text",
                  "name": "city"
                },
                {
                  "type": "text",
                  "name": "state"
                },
                {
                  "type": "text",
                  "name": "zip"
                },
                {
                  "type": "text",
                  "name": "address1"
                },
                {
                  "type": "text",
                  "name": "address2"
                },
                {
                  "type": "text",
                  "name": "salesFirstName"
                },
                {
                  "type": "text",
                  "name": "salesLastName"
                },
                {
                  "type": "text",
                  "name": "salesEmail"
                },
                {
                  "type": "text",
                  "name": "salesPhone"
                }
              ],
              "outputType": "object"
            }
          },
          "else": {
            "steps": {
              "name": "facility",
              "module": "dbconnector",
              "action": "single",
              "options": {
                "connection": "EnyrgyDB",
                "sql": {
                  "type": "select",
                  "columns": [
                    {
                      "table": "facility",
                      "column": "*"
                    }
                  ],
                  "params": [
                    {
                      "operator": "equal",
                      "type": "expression",
                      "name": ":P1",
                      "value": "{{client.id}}",
                      "test": ""
                    },
                    {
                      "operator": "equal",
                      "type": "expression",
                      "name": ":P2",
                      "value": "{{$_PARAM.serial}}",
                      "test": ""
                    }
                  ],
                  "table": {
                    "name": "facility"
                  },
                  "primary": "id",
                  "joins": [
                    {
                      "table": "device",
                      "column": "*",
                      "type": "INNER",
                      "clauses": {
                        "condition": "AND",
                        "rules": [
                          {
                            "table": "device",
                            "column": "facilityId",
                            "operator": "equal",
                            "operation": "=",
                            "value": {
                              "table": "facility",
                              "column": "id"
                            }
                          }
                        ]
                      },
                      "primary": "id"
                    },
                    {
                      "table": "detailsFacility",
                      "column": "*",
                      "type": "INNER",
                      "clauses": {
                        "condition": "AND",
                        "rules": [
                          {
                            "table": "detailsFacility",
                            "column": "facilityId",
                            "operator": "equal",
                            "operation": "=",
                            "value": {
                              "table": "facility",
                              "column": "id"
                            }
                          }
                        ]
                      },
                      "primary": "id"
                    },
                    {
                      "table": "detailsClient",
                      "column": "*",
                      "type": "INNER",
                      "clauses": {
                        "condition": "AND",
                        "rules": [
                          {
                            "table": "detailsClient",
                            "column": "subscriptionId",
                            "operator": "equal",
                            "operation": "=",
                            "value": {
                              "table": "detailsFacility",
                              "column": "subscriptionId"
                            }
                          }
                        ]
                      },
                      "primary": "id"
                    }
                  ],
                  "query": "select \"facility\".* from \"facility\" inner join \"device\" on \"device\".\"facilityId\" = \"facility\".\"id\" inner join \"detailsFacility\" on \"detailsFacility\".\"facilityId\" = \"facility\".\"id\" inner join \"detailsClient\" on \"detailsClient\".\"subscriptionId\" = \"detailsFacility\".\"subscriptionId\" where \"detailsClient\".\"clientId\" = ? and \"device\".\"serial\" = ?",
                  "wheres": {
                    "condition": "AND",
                    "rules": [
                      {
                        "id": "detailsClient.clientId",
                        "field": "detailsClient.clientId",
                        "type": "double",
                        "operator": "equal",
                        "value": "{{client.id}}",
                        "data": {
                          "table": "detailsClient",
                          "column": "clientId",
                          "type": "number",
                          "columnObj": {
                            "type": "reference",
                            "primary": false,
                            "unique": false,
                            "nullable": true,
                            "references": "id",
                            "inTable": "client",
                            "referenceType": "integer",
                            "onUpdate": "CASCADE",
                            "onDelete": "CASCADE",
                            "name": "clientId"
                          }
                        },
                        "operation": "="
                      },
                      {
                        "id": "device.serial",
                        "field": "device.serial",
                        "type": "string",
                        "operator": "equal",
                        "value": "{{$_PARAM.serial}}",
                        "data": {
                          "table": "device",
                          "column": "serial",
                          "type": "text",
                          "columnObj": {
                            "type": "string",
                            "maxLength": 255,
                            "primary": false,
                            "unique": false,
                            "nullable": true,
                            "name": "serial"
                          }
                        },
                        "operation": "="
                      }
                    ],
                    "conditional": null,
                    "valid": true
                  }
                }
              },
              "meta": [
                {
                  "type": "number",
                  "name": "id"
                },
                {
                  "type": "text",
                  "name": "logo"
                },
                {
                  "type": "text",
                  "name": "phone"
                },
                {
                  "type": "boolean",
                  "name": "disabled"
                },
                {
                  "type": "datetime",
                  "name": "createdAt"
                },
                {
                  "type": "datetime",
                  "name": "updatedAt"
                },
                {
                  "type": "text",
                  "name": "name"
                },
                {
                  "type": "text",
                  "name": "email"
                },
                {
                  "type": "text",
                  "name": "city"
                },
                {
                  "type": "text",
                  "name": "state"
                },
                {
                  "type": "text",
                  "name": "zip"
                },
                {
                  "type": "text",
                  "name": "address1"
                },
                {
                  "type": "text",
                  "name": "address2"
                },
                {
                  "type": "text",
                  "name": "salesFirstName"
                },
                {
                  "type": "text",
                  "name": "salesLastName"
                },
                {
                  "type": "text",
                  "name": "salesEmail"
                },
                {
                  "type": "text",
                  "name": "salesPhone"
                }
              ],
              "outputType": "object"
            }
          }
        },
        "outputType": "boolean"
      },
      {
        "name": "facilityId",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "facilityId",
          "value": "{{facility.id}}"
        },
        "meta": [],
        "outputType": "object",
        "output": true
      },
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{facility||$_PARAM.fullAccess}}",
          "then": {
            "steps": [
              {
                "name": "treatment",
                "module": "dbconnector",
                "action": "single",
                "options": {
                  "connection": "EnyrgyDB",
                  "sql": {
                    "type": "SELECT",
                    "distinct": false,
                    "columns": [],
                    "table": {
                      "name": "treatments"
                    },
                    "joins": [],
                    "wheres": {
                      "condition": "AND",
                      "rules": [
                        {
                          "id": "treatments.clientId",
                          "field": "treatments.clientId",
                          "type": "double",
                          "operator": "equal",
                          "value": "{{client.id}}",
                          "data": {
                            "table": "treatments",
                            "column": "clientId",
                            "type": "number",
                            "columnObj": {
                              "type": "reference",
                              "primary": false,
                              "unique": false,
                              "nullable": true,
                              "references": "id",
                              "inTable": "client",
                              "referenceType": "integer",
                              "onUpdate": "CASCADE",
                              "onDelete": "CASCADE",
                              "name": "clientId"
                            }
                          },
                          "operation": "="
                        },
                        {
                          "id": "treatments.complete",
                          "field": "treatments.complete",
                          "type": "boolean",
                          "operator": "equal",
                          "value": true,
                          "data": {
                            "table": "treatments",
                            "column": "complete",
                            "type": "boolean",
                            "columnObj": {
                              "type": "boolean",
                              "default": "false",
                              "primary": false,
                              "unique": false,
                              "nullable": true,
                              "name": "complete"
                            }
                          },
                          "operation": "="
                        }
                      ],
                      "conditional": null,
                      "valid": true
                    },
                    "orders": [
                      {
                        "table": "treatments",
                        "column": "createdAt",
                        "direction": "DESC",
                        "recid": 1
                      }
                    ],
                    "params": [
                      {
                        "operator": "equal",
                        "type": "expression",
                        "name": ":P1",
                        "value": "{{client.id}}",
                        "test": ""
                      }
                    ],
                    "primary": "id",
                    "query": "select * from \"treatments\" where \"treatments\".\"clientId\" = ? and \"treatments\".\"complete\" = ? order by \"createdAt\" DESC",
                    "dir": "",
                    "sort": ""
                  }
                },
                "meta": [
                  {
                    "type": "number",
                    "name": "id"
                  },
                  {
                    "type": "number",
                    "name": "duration"
                  },
                  {
                    "type": "datetime",
                    "name": "createdAt"
                  },
                  {
                    "type": "datetime",
                    "name": "updatedAt"
                  },
                  {
                    "type": "boolean",
                    "name": "complete"
                  },
                  {
                    "type": "number",
                    "name": "clientId"
                  },
                  {
                    "type": "datetime",
                    "name": "lastTreatment"
                  },
                  {
                    "type": "boolean",
                    "name": "redness"
                  },
                  {
                    "type": "number",
                    "name": "facilityId"
                  },
                  {
                    "type": "boolean",
                    "name": "isPlan"
                  },
                  {
                    "type": "number",
                    "name": "paymentId"
                  },
                  {
                    "type": "number",
                    "name": "time"
                  }
                ],
                "outputType": "object",
                "type": "dbconnector_single"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{!treatment}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "condition",
                      "options": {
                        "if": "{{skinType===1}}",
                        "then": {
                          "steps": {
                            "name": "time",
                            "module": "core",
                            "action": "setvalue",
                            "options": {
                              "value": 0,
                              "key": "time"
                            },
                            "meta": [],
                            "outputType": "number",
                            "output": true
                          }
                        },
                        "else": {
                          "steps": [
                            {
                              "name": "detailSkintype",
                              "module": "dbconnector",
                              "action": "single",
                              "options": {
                                "connection": "EnyrgyDB",
                                "sql": {
                                  "type": "select",
                                  "sort": "",
                                  "dir": "",
                                  "columns": [
                                    {
                                      "table": "detailsFitzpatrickSkinType",
                                      "column": "time"
                                    }
                                  ],
                                  "params": [
                                    {
                                      "operator": "equal",
                                      "type": "expression",
                                      "name": ":P1",
                                      "value": "{{skinType}}",
                                      "test": "2"
                                    }
                                  ],
                                  "table": {
                                    "name": "detailsFitzpatrickSkinType"
                                  },
                                  "primary": "id",
                                  "joins": [],
                                  "wheres": {
                                    "condition": "AND",
                                    "rules": [
                                      {
                                        "id": "detailsFitzpatrickSkinType.fitzpatrickSkinTypeId",
                                        "field": "detailsFitzpatrickSkinType.fitzpatrickSkinTypeId",
                                        "type": "double",
                                        "operator": "equal",
                                        "value": "{{skinType}}",
                                        "data": {
                                          "table": "detailsFitzpatrickSkinType",
                                          "column": "fitzpatrickSkinTypeId",
                                          "type": "number",
                                          "columnObj": {
                                            "type": "reference",
                                            "primary": false,
                                            "unique": false,
                                            "nullable": true,
                                            "references": "id",
                                            "inTable": "fitzpatrickSkinType",
                                            "referenceType": "integer",
                                            "onUpdate": "CASCADE",
                                            "onDelete": "CASCADE",
                                            "name": "fitzpatrickSkinTypeId"
                                          }
                                        },
                                        "operation": "=",
                                        "table": "detailsFitzpatrickSkinType"
                                      }
                                    ],
                                    "conditional": null,
                                    "valid": true
                                  },
                                  "query": "select \"time\" from \"detailsFitzpatrickSkinType\" where \"detailsFitzpatrickSkinType\".\"fitzpatrickSkinTypeId\" = ? order by \"id\" ASC",
                                  "orders": [
                                    {
                                      "table": "detailsFitzpatrickSkinType",
                                      "column": "id",
                                      "direction": "ASC",
                                      "recid": 1
                                    }
                                  ]
                                }
                              },
                              "meta": [
                                {
                                  "type": "number",
                                  "name": "time"
                                }
                              ],
                              "type": "dbconnector_single",
                              "outputType": "object"
                            },
                            {
                              "name": "time",
                              "module": "core",
                              "action": "setvalue",
                              "options": {
                                "value": "{{detailSkintype.time}}",
                                "key": "time"
                              },
                              "meta": [],
                              "outputType": "number",
                              "output": true
                            }
                          ]
                        }
                      },
                      "outputType": "boolean"
                    }
                  },
                  "else": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "condition",
                      "options": {
                        "if": "{{treatment.redness}}",
                        "then": {
                          "steps": [
                            {
                              "name": "time",
                              "module": "core",
                              "action": "setvalue",
                              "options": {
                                "key": "time",
                                "value": "{{treatment.duration-15}}"
                              },
                              "meta": [
                                {
                                  "name": "id",
                                  "type": "number"
                                },
                                {
                                  "name": "duration",
                                  "type": "number"
                                },
                                {
                                  "name": "createdAt",
                                  "type": "datetime"
                                },
                                {
                                  "name": "updatedAt",
                                  "type": "datetime"
                                },
                                {
                                  "name": "complete",
                                  "type": "boolean"
                                },
                                {
                                  "name": "clientId",
                                  "type": "number"
                                },
                                {
                                  "name": "lastTreatment",
                                  "type": "datetime"
                                },
                                {
                                  "name": "redness",
                                  "type": "boolean"
                                },
                                {
                                  "name": "facilityId",
                                  "type": "number"
                                },
                                {
                                  "name": "isPlan",
                                  "type": "boolean"
                                },
                                {
                                  "name": "paymentId",
                                  "type": "number"
                                },
                                {
                                  "name": "time",
                                  "type": "number"
                                }
                              ],
                              "outputType": "number",
                              "output": true
                            },
                            {
                              "name": "tooManyRedness",
                              "module": "core",
                              "action": "setvalue",
                              "options": {
                                "key": "tooManyRedness",
                                "value": "{{time<15}}"
                              },
                              "meta": [],
                              "outputType": "boolean",
                              "output": true
                            }
                          ]
                        },
                        "else": {
                          "steps": [
                            {
                              "name": "anyTreatmentWithRedness",
                              "module": "dbupdater",
                              "action": "custom",
                              "options": {
                                "connection": "EnyrgyDB",
                                "sql": {
                                  "query": "SELECT count(*) as \"total\"\nFROM treatments\nWHERE id >= \n(SELECT id\nFROM treatments\nWHERE \"clientId\" = :P1 /* {{client.id}} */ AND redness = true ORDER BY \"id\" DESC LIMIT 1)\nAND \"clientId\" = :P1 /* {{client.id}} */ LIMIT 1",
                                  "params": [
                                    {
                                      "name": ":P1",
                                      "value": "{{client.id}}",
                                      "test": ""
                                    }
                                  ]
                                }
                              },
                              "meta": [
                                {
                                  "name": "total",
                                  "type": "number"
                                }
                              ],
                              "outputType": "object",
                              "type": "dbcustom_query"
                            },
                            {
                              "name": "totalTreatmentsAfterRedness",
                              "module": "core",
                              "action": "setvalue",
                              "options": {
                                "key": "totalTreatmentsAfterRedness",
                                "value": "{{anyTreatmentWithRedness[0].total.toNumber()}}"
                              },
                              "meta": [],
                              "outputType": "number",
                              "output": true
                            },
                            {
                              "name": "",
                              "module": "core",
                              "action": "condition",
                              "options": {
                                "if": "{{totalTreatmentsAfterRedness>0}}",
                                "then": {
                                  "steps": {
                                    "name": "",
                                    "module": "core",
                                    "action": "condition",
                                    "options": {
                                      "if": "{{totalTreatmentsAfterRedness>8}}",
                                      "then": {
                                        "steps": {
                                          "name": "time",
                                          "module": "core",
                                          "action": "setvalue",
                                          "options": {
                                            "key": "time",
                                            "value": "{{treatment.duration>=105?120:treatment.duration+15}}"
                                          },
                                          "meta": [
                                            {
                                              "name": "id",
                                              "type": "number"
                                            },
                                            {
                                              "name": "duration",
                                              "type": "number"
                                            },
                                            {
                                              "name": "createdAt",
                                              "type": "datetime"
                                            },
                                            {
                                              "name": "updatedAt",
                                              "type": "datetime"
                                            },
                                            {
                                              "name": "complete",
                                              "type": "boolean"
                                            },
                                            {
                                              "name": "clientId",
                                              "type": "number"
                                            },
                                            {
                                              "name": "lastTreatment",
                                              "type": "datetime"
                                            },
                                            {
                                              "name": "redness",
                                              "type": "boolean"
                                            },
                                            {
                                              "name": "facilityId",
                                              "type": "number"
                                            },
                                            {
                                              "name": "isPlan",
                                              "type": "boolean"
                                            },
                                            {
                                              "name": "paymentId",
                                              "type": "number"
                                            },
                                            {
                                              "name": "time",
                                              "type": "number"
                                            }
                                          ],
                                          "outputType": "number",
                                          "output": true
                                        }
                                      },
                                      "else": {
                                        "steps": {
                                          "name": "time",
                                          "module": "core",
                                          "action": "setvalue",
                                          "options": {
                                            "key": "time",
                                            "value": "{{treatment.duration}}"
                                          },
                                          "meta": [],
                                          "outputType": "number",
                                          "output": true
                                        }
                                      }
                                    },
                                    "outputType": "boolean"
                                  }
                                },
                                "else": {
                                  "steps": [
                                    {
                                      "name": "totalTreatments",
                                      "module": "dbconnector",
                                      "action": "single",
                                      "options": {
                                        "connection": "EnyrgyDB",
                                        "sql": {
                                          "type": "select",
                                          "columns": [
                                            {
                                              "table": "treatments",
                                              "column": "*",
                                              "aggregate": "COUNT",
                                              "alias": "total"
                                            }
                                          ],
                                          "params": [
                                            {
                                              "operator": "equal",
                                              "type": "expression",
                                              "name": ":P1",
                                              "value": "{{client.id}}",
                                              "test": ""
                                            }
                                          ],
                                          "table": {
                                            "name": "treatments"
                                          },
                                          "primary": "id",
                                          "joins": [],
                                          "groupBy": [],
                                          "query": "select count(*) as \"total\" from \"treatments\" where \"treatments\".\"clientId\" = ? and \"treatments\".\"complete\" = ?",
                                          "wheres": {
                                            "condition": "AND",
                                            "rules": [
                                              {
                                                "id": "treatments.clientId",
                                                "field": "treatments.clientId",
                                                "type": "double",
                                                "operator": "equal",
                                                "value": "{{client.id}}",
                                                "data": {
                                                  "table": "treatments",
                                                  "column": "clientId",
                                                  "type": "number",
                                                  "columnObj": {
                                                    "type": "reference",
                                                    "primary": false,
                                                    "unique": false,
                                                    "nullable": true,
                                                    "references": "id",
                                                    "inTable": "client",
                                                    "referenceType": "integer",
                                                    "onUpdate": "CASCADE",
                                                    "onDelete": "CASCADE",
                                                    "name": "clientId"
                                                  }
                                                },
                                                "operation": "="
                                              },
                                              {
                                                "id": "treatments.complete",
                                                "field": "treatments.complete",
                                                "type": "boolean",
                                                "operator": "equal",
                                                "value": true,
                                                "data": {
                                                  "table": "treatments",
                                                  "column": "complete",
                                                  "type": "boolean",
                                                  "columnObj": {
                                                    "type": "boolean",
                                                    "default": "false",
                                                    "primary": false,
                                                    "unique": false,
                                                    "nullable": true,
                                                    "name": "complete"
                                                  }
                                                },
                                                "operation": "="
                                              }
                                            ],
                                            "conditional": null,
                                            "valid": true
                                          }
                                        }
                                      },
                                      "meta": [
                                        {
                                          "type": "number",
                                          "name": "id"
                                        },
                                        {
                                          "type": "number",
                                          "name": "duration"
                                        },
                                        {
                                          "type": "datetime",
                                          "name": "createdAt"
                                        },
                                        {
                                          "type": "datetime",
                                          "name": "updatedAt"
                                        },
                                        {
                                          "type": "boolean",
                                          "name": "complete"
                                        },
                                        {
                                          "type": "number",
                                          "name": "clientId"
                                        },
                                        {
                                          "type": "datetime",
                                          "name": "lastTreatment"
                                        },
                                        {
                                          "type": "boolean",
                                          "name": "redness"
                                        },
                                        {
                                          "type": "number",
                                          "name": "facilityId"
                                        },
                                        {
                                          "type": "boolean",
                                          "name": "isPlan"
                                        },
                                        {
                                          "type": "number",
                                          "name": "paymentId"
                                        },
                                        {
                                          "type": "number",
                                          "name": "time"
                                        }
                                      ],
                                      "outputType": "object"
                                    },
                                    {
                                      "name": "totalTreatmentsValue",
                                      "module": "core",
                                      "action": "setvalue",
                                      "options": {
                                        "key": "totalTreatmentsValue",
                                        "value": "{{totalTreatments.total.toNumber()||0}}"
                                      },
                                      "meta": [
                                        {
                                          "name": "id",
                                          "type": "number"
                                        },
                                        {
                                          "name": "duration",
                                          "type": "number"
                                        },
                                        {
                                          "name": "createdAt",
                                          "type": "datetime"
                                        },
                                        {
                                          "name": "updatedAt",
                                          "type": "datetime"
                                        },
                                        {
                                          "name": "complete",
                                          "type": "boolean"
                                        },
                                        {
                                          "name": "clientId",
                                          "type": "number"
                                        },
                                        {
                                          "name": "lastTreatment",
                                          "type": "datetime"
                                        },
                                        {
                                          "name": "redness",
                                          "type": "boolean"
                                        },
                                        {
                                          "name": "facilityId",
                                          "type": "number"
                                        },
                                        {
                                          "name": "isPlan",
                                          "type": "boolean"
                                        },
                                        {
                                          "name": "paymentId",
                                          "type": "number"
                                        },
                                        {
                                          "name": "time",
                                          "type": "number"
                                        }
                                      ],
                                      "outputType": "number",
                                      "output": true
                                    },
                                    {
                                      "name": "detailSkintypeTreatment",
                                      "module": "dbconnector",
                                      "action": "single",
                                      "options": {
                                        "connection": "EnyrgyDB",
                                        "sql": {
                                          "type": "select",
                                          "sort": "",
                                          "dir": "",
                                          "columns": [
                                            {
                                              "table": "detailsFitzpatrickSkinType",
                                              "column": "time"
                                            }
                                          ],
                                          "params": [
                                            {
                                              "operator": "equal",
                                              "type": "expression",
                                              "name": ":P1",
                                              "value": "{{skinType}}",
                                              "test": ""
                                            },
                                            {
                                              "operator": "equal",
                                              "type": "expression",
                                              "name": ":P2",
                                              "value": "{{totalTreatmentsValue>=40?40:(totalTreatmentsValue+1)}}",
                                              "test": ""
                                            }
                                          ],
                                          "table": {
                                            "name": "detailsFitzpatrickSkinType"
                                          },
                                          "primary": "id",
                                          "joins": [],
                                          "wheres": {
                                            "condition": "AND",
                                            "rules": [
                                              {
                                                "id": "detailsFitzpatrickSkinType.fitzpatrickSkinTypeId",
                                                "field": "detailsFitzpatrickSkinType.fitzpatrickSkinTypeId",
                                                "type": "double",
                                                "operator": "equal",
                                                "value": "{{skinType}}",
                                                "data": {
                                                  "table": "detailsFitzpatrickSkinType",
                                                  "column": "fitzpatrickSkinTypeId",
                                                  "type": "number",
                                                  "columnObj": {
                                                    "type": "reference",
                                                    "primary": false,
                                                    "unique": false,
                                                    "nullable": true,
                                                    "references": "id",
                                                    "inTable": "fitzpatrickSkinType",
                                                    "referenceType": "integer",
                                                    "onUpdate": "CASCADE",
                                                    "onDelete": "CASCADE",
                                                    "name": "fitzpatrickSkinTypeId"
                                                  }
                                                },
                                                "operation": "="
                                              },
                                              {
                                                "id": "detailsFitzpatrickSkinType.treatment",
                                                "field": "detailsFitzpatrickSkinType.treatment",
                                                "type": "double",
                                                "operator": "equal",
                                                "value": "{{totalTreatmentsValue>=40?40:(totalTreatmentsValue+1)}}",
                                                "data": {
                                                  "table": "detailsFitzpatrickSkinType",
                                                  "column": "treatment",
                                                  "type": "number",
                                                  "columnObj": {
                                                    "type": "integer",
                                                    "primary": false,
                                                    "unique": false,
                                                    "nullable": true,
                                                    "name": "treatment"
                                                  }
                                                },
                                                "operation": "="
                                              }
                                            ],
                                            "conditional": null,
                                            "valid": true
                                          },
                                          "query": "select \"time\" from \"detailsFitzpatrickSkinType\" where \"detailsFitzpatrickSkinType\".\"fitzpatrickSkinTypeId\" = ? and \"detailsFitzpatrickSkinType\".\"treatment\" = ?"
                                        }
                                      },
                                      "meta": [
                                        {
                                          "type": "number",
                                          "name": "time"
                                        }
                                      ],
                                      "type": "dbconnector_single",
                                      "outputType": "object"
                                    },
                                    {
                                      "name": "time",
                                      "module": "core",
                                      "action": "setvalue",
                                      "options": {
                                        "key": "time",
                                        "value": "{{detailSkintypeTreatment.time}}"
                                      },
                                      "meta": [],
                                      "outputType": "number",
                                      "output": true
                                    }
                                  ]
                                }
                              },
                              "outputType": "boolean"
                            }
                          ]
                        }
                      },
                      "outputType": "boolean"
                    }
                  }
                },
                "outputType": "boolean"
              }
            ]
          },
          "else": {
            "steps": {
              "name": "hasFacility",
              "module": "core",
              "action": "setvalue",
              "options": {
                "key": "hasFacility",
                "value": false
              },
              "meta": [],
              "outputType": "boolean",
              "output": true
            }
          }
        },
        "outputType": "boolean"
      }
    ]
  }
}