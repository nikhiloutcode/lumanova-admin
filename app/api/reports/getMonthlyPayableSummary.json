{
  "meta": {
    "$_GET": [
      {
        "type": "text",
        "name": "sort"
      },
      {
        "type": "text",
        "name": "dir"
      },
      {
        "type": "text",
        "name": "month"
      },
      {
        "type": "text",
        "name": "year"
      }
    ],
    "$_POST": [
      {
        "type": "text",
        "name": "month"
      },
      {
        "type": "text",
        "name": "year"
      }
    ],
    "$_SERVER": [
      {
        "type": "text",
        "name": "HTTP_AUTHORIZATION"
      }
    ]
  },
  "exec": {
    "steps": [
      {
        "name": "",
        "options": {
          "comment": "TODO: Fix subscriptions with no treatments are not being added up to the energyBalancePayable var"
        }
      },
      {
        "name": "jwt",
        "module": "core",
        "action": "exec",
        "options": {
          "exec": "utils/verifyJWT",
          "params": {
            "token": "{{$_SERVER.HTTP_AUTHORIZATION}}"
          }
        }
      },
      {
        "name": "SILVER_TREATMENT_PRICE",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 4.13
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "GOLD_TREATMENT_PRICE",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 2.63
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "PLATINUM_TREATMENT_PRICE",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 2.1
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "STRIPE_FEE_PERCENT",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0.029
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "STRIPE_FEE_FIXED",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0.3
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "COMMISSION_PERCENT",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0.05
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "month",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{$_POST.month||$_GET.month}}"
        },
        "meta": [],
        "outputType": "text"
      },
      {
        "name": "year",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{$_POST.year||$_GET.year}}"
        },
        "meta": [],
        "outputType": "text"
      },
      {
        "name": "",
        "options": {
          "comment": "globals - enyrgy totals"
        }
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "silverEnyrgyBalance",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "silverEnyrgyProfit",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "goldEnyrgyBalance",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "goldEnyrgyProfit",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "platinumEnyrgyBalance",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "platinumEnyrgyProfit",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "options": {
          "comment": "globals - total treatments"
        }
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0,
          "key": "silverTotalTreatments"
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0,
          "key": "goldTotalTreatments"
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": 0,
          "key": "platinumTotalTreatments"
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "options": {
          "comment": "globals - pending treatments"
        }
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "silverPendingTreatments",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "goldPendingTreatments",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "module": "core",
        "action": "setvalue",
        "options": {
          "key": "platinumPendingTreatments",
          "value": 0
        },
        "meta": [],
        "outputType": "number"
      },
      {
        "name": "",
        "options": {
          "comment": "get plans' limit sessions and cost"
        }
      },
      {
        "name": "silverPlan",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "select",
            "columns": [
              {
                "table": "plans",
                "column": "limitSessions"
              },
              {
                "table": "plans",
                "column": "amount"
              }
            ],
            "params": [],
            "table": {
              "name": "plans"
            },
            "primary": "id",
            "joins": [],
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "plans.name",
                  "field": "plans.name",
                  "type": "string",
                  "operator": "equal",
                  "value": "Silver",
                  "data": {
                    "table": "plans",
                    "column": "name",
                    "type": "text",
                    "columnObj": {
                      "type": "string",
                      "maxLength": 255,
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "name"
                    }
                  },
                  "operation": "="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "query": "select \"limitSessions\", \"amount\" from \"plans\" where \"plans\".\"name\" = ?"
          }
        },
        "meta": [
          {
            "type": "text",
            "name": "limitSessions"
          },
          {
            "type": "text",
            "name": "amount"
          }
        ],
        "outputType": "object"
      },
      {
        "name": "goldPlan",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "select",
            "columns": [
              {
                "table": "plans",
                "column": "limitSessions"
              },
              {
                "table": "plans",
                "column": "amount"
              }
            ],
            "params": [],
            "table": {
              "name": "plans"
            },
            "primary": "id",
            "joins": [],
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "plans.name",
                  "field": "plans.name",
                  "type": "string",
                  "operator": "equal",
                  "value": "Gold",
                  "data": {
                    "table": "plans",
                    "column": "name",
                    "type": "text",
                    "columnObj": {
                      "type": "string",
                      "maxLength": 255,
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "name"
                    }
                  },
                  "operation": "="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "query": "select \"limitSessions\", \"amount\" from \"plans\" where \"plans\".\"name\" = ?"
          }
        },
        "meta": [
          {
            "type": "text",
            "name": "limitSessions"
          },
          {
            "type": "text",
            "name": "amount"
          }
        ],
        "outputType": "object"
      },
      {
        "name": "platinumPlan",
        "module": "dbconnector",
        "action": "single",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "type": "select",
            "columns": [
              {
                "table": "plans",
                "column": "limitSessions"
              },
              {
                "table": "plans",
                "column": "amount"
              }
            ],
            "params": [
              {
                "operator": "equal",
                "type": "expression",
                "name": ":P1",
                "value": "{{'Platinum'}}",
                "test": ""
              }
            ],
            "table": {
              "name": "plans"
            },
            "primary": "id",
            "joins": [],
            "wheres": {
              "condition": "AND",
              "rules": [
                {
                  "id": "plans.name",
                  "field": "plans.name",
                  "type": "string",
                  "operator": "equal",
                  "value": "{{'Platinum'}}",
                  "data": {
                    "table": "plans",
                    "column": "name",
                    "type": "text",
                    "columnObj": {
                      "type": "string",
                      "maxLength": 255,
                      "primary": false,
                      "unique": false,
                      "nullable": true,
                      "name": "name"
                    }
                  },
                  "operation": "="
                }
              ],
              "conditional": null,
              "valid": true
            },
            "query": "select \"limitSessions\", \"amount\" from \"plans\" where \"plans\".\"name\" = ?"
          }
        },
        "meta": [
          {
            "type": "text",
            "name": "limitSessions"
          },
          {
            "type": "text",
            "name": "amount"
          }
        ],
        "outputType": "object"
      },
      {
        "name": "",
        "options": {
          "comment": "== GET ENYRGY RELATED TOTALS =="
        }
      },
      {
        "name": "subscriptions",
        "module": "dbupdater",
        "action": "custom",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "query": "SELECT dp.id, dp.\"planId\", p.name AS \"planName\", p.\"limitSessions\"\nFROM \"detailsPayment\" dp\nINNER JOIN plans p ON p.id = dp.\"planId\"\nWHERE TO_CHAR(dp.\"createdAt\", 'MM') = :P1 AND TO_CHAR(dp.\"createdAt\", 'YYYY') = :P2 AND dp.\"freeTrialEndAt\" IS NULL\nORDER BY dp.id",
            "params": [
              {
                "name": ":P1",
                "value": "{{month}}",
                "test": "11"
              },
              {
                "name": ":P2",
                "value": "{{year}}",
                "test": "2023"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "id",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          },
          {
            "name": "limitSessions",
            "type": "text"
          }
        ]
      },
      {
        "name": "subscriptionsNewLoop",
        "module": "core",
        "action": "repeat",
        "options": {
          "repeat": "{{subscriptions}}",
          "outputFields": [],
          "exec": {
            "steps": [
              {
                "name": "subscription",
                "module": "core",
                "action": "setvalue",
                "options": {
                  "value": "{{$value}}"
                },
                "meta": [],
                "outputType": "object",
                "output": true
              },
              {
                "name": "completedTreatments",
                "module": "dbupdater",
                "action": "custom",
                "options": {
                  "connection": "EnyrgyDB",
                  "sql": {
                    "query": "SELECT COUNT(id)\nFROM treatments\nWHERE \"paymentId\" = :P1 AND complete = TRUE AND TO_CHAR(\"createdAt\", 'MM') = :P2 AND TO_CHAR(\"createdAt\", 'YYYY') = :P3",
                    "params": [
                      {
                        "name": ":P1",
                        "value": "{{subscription.id}}",
                        "test": "173"
                      },
                      {
                        "name": ":P2",
                        "value": "{{month}}",
                        "test": "11"
                      },
                      {
                        "name": ":P3",
                        "value": "{{year}}",
                        "test": "2023"
                      }
                    ]
                  }
                },
                "output": false,
                "meta": [
                  {
                    "name": "count",
                    "type": "number"
                  }
                ]
              },
              {
                "name": "pendingTreatments",
                "module": "core",
                "action": "setvalue",
                "options": {
                  "value": "{{subscription.limitSessions.toNumber()-completedTreatments[0].count.toNumber()}}"
                },
                "meta": [],
                "outputType": "number",
                "output": true
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{subscription.planName=='Silver'}}",
                  "then": {
                    "steps": [
                      {
                        "name": "stripeFees",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{(((silverPlan.amount.toNumber()*STRIPE_FEE_PERCENT)+STRIPE_FEE_FIXED).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "commissions",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((silverPlan.amount.toNumber() * COMMISSION_PERCENT).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "netSubscriptionAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{silverPlan.amount.toNumber()-stripeFees-commissions}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyTreatmentAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((netSubscriptionAmount/silverPlan.limitSessions.toNumber()).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "facilityTotal",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{pendingTreatments*SILVER_TREATMENT_PRICE}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyBalance",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyTreatmentAmount*pendingTreatments).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyProfit",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyBalance-facilityTotal).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "silverEnyrgyBalance",
                          "value": "{{((silverEnyrgyBalance+enyrgyBalance).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": false
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "silverEnyrgyProfit",
                          "value": "{{((silverEnyrgyProfit+enyrgyProfit).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number"
                      }
                    ]
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{subscription.planName=='Gold'}}",
                  "then": {
                    "steps": [
                      {
                        "name": "stripeFees",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{(((goldPlan.amount.toNumber()*STRIPE_FEE_PERCENT)+STRIPE_FEE_FIXED).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "commissions",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((goldPlan.amount.toNumber() * COMMISSION_PERCENT).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "netSubscriptionAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{goldPlan.amount.toNumber()-stripeFees-commissions}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyTreatmentAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((netSubscriptionAmount/goldPlan.limitSessions.toNumber()).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "facilityTotal",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{pendingTreatments*GOLD_TREATMENT_PRICE}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyBalance",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyTreatmentAmount*pendingTreatments).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyProfit",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyBalance-facilityTotal).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "goldEnyrgyBalance",
                          "value": "{{((goldEnyrgyBalance+enyrgyBalance).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": false
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "goldEnyrgyProfit",
                          "value": "{{((goldEnyrgyProfit + enyrgyProfit).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number"
                      }
                    ]
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{subscription.planName=='Platinum'}}",
                  "then": {
                    "steps": [
                      {
                        "name": "stripeFees",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{(((platinumPlan.amount.toNumber()*STRIPE_FEE_PERCENT)+STRIPE_FEE_FIXED).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "commissions",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((platinumPlan.amount.toNumber() * COMMISSION_PERCENT).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "netSubscriptionAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{platinumPlan.amount.toNumber()-stripeFees-commissions}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyTreatmentAmount",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((netSubscriptionAmount/platinumPlan.limitSessions.toNumber()).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "facilityTotal",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{pendingTreatments*PLATINUM_TREATMENT_PRICE}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyBalance",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyTreatmentAmount*pendingTreatments).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "enyrgyProfit",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "value": "{{((enyrgyBalance-facilityTotal).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": true
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "platinumEnyrgyBalance",
                          "value": "{{((platinumEnyrgyBalance+enyrgyBalance).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number",
                        "output": false
                      },
                      {
                        "name": "",
                        "module": "core",
                        "action": "setvalue",
                        "options": {
                          "key": "platinumEnyrgyProfit",
                          "value": "{{((platinumEnyrgyProfit + enyrgyProfit).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
                        },
                        "meta": [],
                        "outputType": "number"
                      }
                    ]
                  }
                },
                "outputType": "boolean"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "$index",
            "type": "number"
          },
          {
            "name": "$number",
            "type": "number"
          },
          {
            "name": "$name",
            "type": "text"
          },
          {
            "name": "$value",
            "type": "object"
          },
          {
            "name": "id",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          },
          {
            "name": "limitSessions",
            "type": "text"
          },
          {
            "name": "subscription",
            "type": "object",
            "sub": []
          },
          {
            "name": "pendingTreatments",
            "type": "number",
            "sub": []
          },
          {
            "name": "stripeFees",
            "type": "number",
            "sub": []
          },
          {
            "name": "commissions",
            "type": "number",
            "sub": []
          },
          {
            "name": "netSubscriptionAmount",
            "type": "number",
            "sub": []
          },
          {
            "name": "enyrgyTreatmentAmount",
            "type": "number",
            "sub": []
          },
          {
            "name": "facilityTotal",
            "type": "number",
            "sub": []
          },
          {
            "name": "enyrgyBalance",
            "type": "number",
            "sub": []
          },
          {
            "name": "enyrgyProfit",
            "type": "number",
            "sub": []
          }
        ],
        "outputType": "array"
      },
      {
        "name": "",
        "options": {
          "comment": "== GET FACILITY RELATED TOTALS =="
        }
      },
      {
        "name": "",
        "options": {
          "comment": "get subscriptions grouped by planId"
        }
      },
      {
        "name": "groupedSubscriptions",
        "module": "dbupdater",
        "action": "custom",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "query": "SELECT\nCOUNT(dp.id) as \"totalSubscriptions\",\ndp.\"planId\",\np.name as \"planName\", p.\"limitSessions\"\nFROM \"detailsPayment\" dp\nINNER JOIN plans p ON p.id = dp.\"planId\"\nWHERE TO_CHAR(dp.\"createdAt\", 'MM') = :P1 AND TO_CHAR(dp.\"createdAt\", 'YYYY') = :P2 AND dp.\"freeTrialEndAt\" IS NULL\nGROUP BY dp.\"planId\", p.name, p.\"limitSessions\"",
            "params": [
              {
                "name": ":P1",
                "value": "{{month}}",
                "test": "11"
              },
              {
                "name": ":P2",
                "value": "{{year}}",
                "test": "2023"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "totalSubscriptions",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          },
          {
            "name": "limitSessions",
            "type": "text"
          }
        ]
      },
      {
        "name": "groupedSubscriptionsLoop",
        "module": "core",
        "action": "repeat",
        "options": {
          "repeat": "{{groupedSubscriptions}}",
          "outputFields": [],
          "exec": {
            "steps": [
              {
                "name": "group",
                "module": "core",
                "action": "setvalue",
                "options": {
                  "value": "{{$value}}"
                },
                "meta": [],
                "outputType": "object"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Silver'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{silverPlan.limitSessions.toNumber()*group.totalSubscriptions.toNumber()}}",
                        "key": "silverTotalTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Gold'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{goldPlan.limitSessions.toNumber()*group.totalSubscriptions.toNumber()}}",
                        "key": "goldTotalTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Platinum'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{platinumPlan.limitSessions.toNumber()*group.totalSubscriptions.toNumber()}}",
                        "key": "platinumTotalTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "silverPlanTreatments",
                "module": "core",
                "action": "setvalue",
                "options": {},
                "meta": [],
                "outputType": "number"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "$index",
            "type": "number"
          },
          {
            "name": "$number",
            "type": "number"
          },
          {
            "name": "$name",
            "type": "text"
          },
          {
            "name": "$value",
            "type": "object"
          },
          {
            "name": "totalSubscriptions",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          },
          {
            "name": "limitSessions",
            "type": "text"
          }
        ],
        "outputType": "array"
      },
      {
        "name": "",
        "options": {
          "comment": "get completed treatments"
        }
      },
      {
        "name": "completedTreatments",
        "module": "dbupdater",
        "action": "custom",
        "options": {
          "connection": "EnyrgyDB",
          "sql": {
            "query": "SELECT\ncount(t.id) as \"totalTreatments\",\ndp.\"planId\",\np.name as \"planName\"\nFROM treatments t\nINNER JOIN \"detailsPayment\" dp ON dp.id = t.\"paymentId\"\nINNER JOIN plans p ON p.id = dp.\"planId\"\nWHERE t.complete = TRUE AND TO_CHAR(t.\"createdAt\", 'MM') = :P1 AND TO_CHAR(t.\"createdAt\", 'YYYY') = :P2 AND t.\"paymentId\" IS NOT NULL AND dp.\"freeTrialEndAt\" IS NULL\nGROUP BY dp.\"planId\", p.name",
            "params": [
              {
                "name": ":P1",
                "value": "{{month}}",
                "test": "11"
              },
              {
                "name": ":P2",
                "value": "{{year}}",
                "test": "2023"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "totalTreatments",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          }
        ]
      },
      {
        "name": "completedTreatmentsLoop",
        "module": "core",
        "action": "repeat",
        "options": {
          "repeat": "{{completedTreatments}}",
          "outputFields": [],
          "exec": {
            "steps": [
              {
                "name": "group",
                "module": "core",
                "action": "setvalue",
                "options": {
                  "value": "{{$value}}"
                },
                "meta": [],
                "outputType": "object"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Silver'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{silverTotalTreatments-group.totalTreatments.toNumber()}}",
                        "key": "silverPendingTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Gold'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{goldTotalTreatments-group.totalTreatments.toNumber()}}",
                        "key": "goldPendingTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              },
              {
                "name": "",
                "module": "core",
                "action": "condition",
                "options": {
                  "if": "{{group.planName=='Platinum'}}",
                  "then": {
                    "steps": {
                      "name": "",
                      "module": "core",
                      "action": "setvalue",
                      "options": {
                        "value": "{{platinumTotalTreatments-group.totalTreatments.toNumber()}}",
                        "key": "platinumPendingTreatments"
                      },
                      "meta": [],
                      "outputType": "number",
                      "output": false
                    }
                  }
                },
                "outputType": "boolean"
              }
            ]
          }
        },
        "output": false,
        "meta": [
          {
            "name": "$index",
            "type": "number"
          },
          {
            "name": "$number",
            "type": "number"
          },
          {
            "name": "$name",
            "type": "text"
          },
          {
            "name": "$value",
            "type": "object"
          },
          {
            "name": "totalTreatments",
            "type": "number"
          },
          {
            "name": "planId",
            "type": "number"
          },
          {
            "name": "planName",
            "type": "text"
          }
        ],
        "outputType": "array"
      },
      {
        "name": "",
        "options": {
          "comment": "outputs"
        }
      },
      {
        "name": "silverTotalPendingTreaments",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{silverPendingTreatments}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "goldTotalPendingTreaments",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{goldPendingTreatments}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "platinumTotalPendingTreaments",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{platinumPendingTreatments}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "totalPendingTreatments",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{silverPendingTreatments+goldPendingTreatments+platinumPendingTreatments}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "silverPayableMoney",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{silverPendingTreatments*SILVER_TREATMENT_PRICE}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "goldPayableMoney",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{goldPendingTreatments*GOLD_TREATMENT_PRICE}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "platinumPayableMoney",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{platinumPendingTreatments*PLATINUM_TREATMENT_PRICE}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "totalPayableMoney",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{((silverPayableMoney + goldPayableMoney + platinumPayableMoney).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "silverEnyrgyBalance",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{silverEnyrgyBalance}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "silverEnyrgyProfit",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{silverEnyrgyProfit}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "goldEnyrgyBalance",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{goldEnyrgyBalance}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "goldEnyrgyProfit",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{goldEnyrgyProfit}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "platinumEnyrgyBalance",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{platinumEnyrgyBalance}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "platinumEnyrgyProfit",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{platinumEnyrgyProfit}}"
        },
        "meta": [],
        "outputType": "number",
        "output": true
      },
      {
        "name": "enyrgyBalancePayable",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{((silverEnyrgyBalance + goldEnyrgyBalance + platinumEnyrgyBalance).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
        },
        "meta": [],
        "output": true,
        "outputType": "number"
      },
      {
        "name": "enyrgyProfitPayable",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{((silverEnyrgyProfit + goldEnyrgyProfit + platinumEnyrgyProfit).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
        },
        "meta": [],
        "output": true,
        "outputType": "number"
      },
      {
        "name": "enyrgyProfitPayable",
        "module": "core",
        "action": "setvalue",
        "options": {
          "value": "{{((enyrgyBalancePayable-totalPayableMoney).formatNumber(2, '.', '\\'\\'')).toNumber()}}"
        },
        "meta": [],
        "output": true,
        "outputType": "number",
        "disabled": true
      }
    ]
  }
}